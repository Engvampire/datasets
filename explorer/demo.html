<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Data Explorer Demo</title>
    
    <!-- JQuery -->
    <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    
    <!-- Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    
    <script src="knockout-3.4.0.js"></script>
    
    <script src="d3.v3.min.js"></script>
    <style>

    body {
      font: 14px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .x.axis path {
      display: none;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 1.5px;
    }
    
    .vertically-align {
        display: inline-block;
        vertical-align: middle;
        float: none;
    }

    </style>
    
    <script>
    
var sampleDataSingle = [1, 2, 3, 4, 5, 6],
    sampleDataSingle2 = [6, 5, 5, 5, 2, 2],
    sampleDataSingle3 = [1, 3, 6, 3, 1, 3],
    sampleDataSingle4 = [-1, -2, -3, -4, -5, -6];
var mainModel = {
    'selected': {
        'dataset': ko.observable('weather'),
        'left': ko.observable('wind speed'),
        'right': ko.observable('humidity'),
        'chart': ko.observable('hist')
    },
    'charts': ko.observableArray([
        {'name': 'Line Plot', 'id': 'line', 'is2d': false},
        {'name': 'Histogram', 'id': 'hist', 'is2d': false},
        {'name': 'XY Plot', 'id': 'xy', 'is2d': true},
        {'name': 'Scatter Plot', 'id': 'scatter', 'is2d': true},
        //{'name': 'Bar Graph', 'id': 'bar', 'is2d': true},
    ]),
    'structures':  ko.observableArray([
        {'name': 'weather', 'data': [
            {'name': 'temperature', 'path': ['temperature'], 'data': [70, 80, 72, 83, 74, 85, 71, 88]},
            {'name': 'humidity', 'path': ['humidity'], 'data': [20, 25, 30, 40, 25, 20, 0, 0]},
            {'name': 'wind direction', 'path': ['wind', 'direction'], 'data': [0, 90, 180, 270, 180, 90, 0, 90]},
            {'name': 'wind speed', 'path': ['wind', 'speed'], 'data': [5, 10, 15, 25, 10, 5, 0, 1]}
        ]},
        {'name': 'earthquakes', 'data': [
            {'name': 'magnitude', 'path': ['magnitude'], 'data': sampleDataSingle4},
            {'name': 'location depth', 'path': ['location', 'depth'], 'data': sampleDataSingle4}
        ]},
        {'name': 'crime', 'data': [
            {'name': 'burglary rates', 'path': ['rates', 'property', 'burglary'], 'data': sampleDataSingle4},
            {'name': 'murder rates', 'path': ['rates', 'violent', 'murder'], 'data': sampleDataSingle4},
            {'name': 'total burglaries', 'path': ['totals', 'property', 'burglary'], 'data': sampleDataSingle4},
            {'name': 'total murders', 'path': ['totals', 'violent', 'murder'], 'data': sampleDataSingle4}
        ]}
    ])
};

$(document).ready(function () {
    ko.applyBindings(mainModel);
    
    var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 600 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var formatDate = d3.time.format("%d-%b-%y");
    
    var x = d3.scale.linear()
        .range([0, width]);
    
    var y = d3.scale.linear()
        .range([height, 0]);
        
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");
        
    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
    
    var line = d3.svg.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); })
        .interpolate("linear");
        
    var xMap = function(d) {return x(d.x)};
    var yMap = function(d) {return y(d.y)};

    var canvas = d3.select("#data-visualization").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
    // TODO: implement http://www.thesoftwaresimpleton.com/blog/2016/01/16/d3-axis/
        
    canvas.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
    canvas.append("g")
          .attr("class", "y axis")
          .call(yAxis);
        
    function changeDataset() {
        var chart = mainModel.selected.chart();
    
        var actualData, ys;
        if (mainModel.selected.chart().is2d) {
            actualData = d3.zip(mainModel.selected.left().data,
                                mainModel.selected.right().data).map(function(element) {
                return {'x': element[0], 'y': element[1]}
            });
        } else {
            ys = mainModel.selected.left().data;
            actualData = ys.map(function(element, index) {
                return {'x': index, 'y': element}
            });
        }
        
        if (chart.id == 'hist') {
            x.domain(d3.extent(ys));
            var histMapper = d3.layout.histogram().bins(x.ticks(20))(ys);
            y.domain([0, d3.max(histMapper, function(d) { return d.y; })]);
        } else {
            x.domain(d3.extent(actualData, function(d) { return d.x; }));
            y.domain(d3.extent(actualData, function(d) { return d.y; }));
        }
    
        // bind data
        
        // add new elements
        if (chart.id != 'xy' && chart.id != 'line') {
            canvas.selectAll("path")
                  .transition()
                  .attr("stroke-width", 0)
                  .remove();
        }
        if (chart.id != 'scatter') {
            canvas.selectAll("circle")
                  .transition()
                  .duration(500)
                  .attr("r", 0)
                  .remove();
        }
        canvas.selectAll("bar").remove();
        canvas.selectAll("rect")
              .transition()
              .duration(500)
              .attr("height", 0)
              .remove();
        var appending;
        if (chart.id == 'xy' || chart.id == 'line') {
            appending = canvas.selectAll('path')
                              .data(actualData);
            appending.enter()
                     .append('path')
                     .attr("d", line(actualData))
                     .attr("stroke", "blue")
                     .attr("stroke-width", 0)
                     .attr("fill", "none")
                 .transition()
                     .attr("stroke-width", 2);
            appending.attr("d", line(actualData));
        } else if (chart.id == 'scatter') {
            appending = canvas.selectAll('circle')
                              .data(actualData);
            appending.enter()
                     .append('circle')
                     .attr("cx", xMap)
                     .attr("cy", yMap)
                     .attr('r', 0)
                     .attr("fill", "blue")
                 .transition()
                     .attr('r', 3.5);
            appending.attr("cx", xMap).attr("cy", yMap);
        } else if (chart.id == 'hist') {
            appending = canvas.selectAll('bar')
                              .data(histMapper);
            var bar = appending.enter().append("g")
                              .attr("class", "bar")
                              .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });
            bar.append("rect")
                .attr("x", 1)
                .attr("width", width/20 - 1)
                .attr("height", function(d) { return height - y(d.y); });
        }
        
        // update existing elements
        
        
            
        // remove old elements
        appending.exit()
                .transition()
                .remove();
        
        // Update the axis
        var xAxis = d3.svg.axis().scale(x).orient("bottom");
        var yAxis = d3.svg.axis().scale(y).orient("left");

        canvas.selectAll("g.y.axis")
            .call(yAxis)

        canvas.selectAll("g.x.axis")
            .call(xAxis);
    }
        
    // generate initial legend
    changeDataset();
    mainModel.selected.left.subscribe(changeDataset);
    mainModel.selected.right.subscribe(changeDataset);
    mainModel.selected.chart.subscribe(changeDataset);
    
    mainModel.selected.chart.subscribe(function (chart_type) {
    });
});
    </script>
    
</head>
<body>
<h1>Data Explorer Demo</h1>
<div class='container'>

<div class='row'>
    <div class='col-md-2'>
        <div class="form-group">
            <label for="choose-dataset">Dataset: </label>
            <select class="form-control" id="choose-dataset"
                    data-bind="options: structures,
                               value: selected.dataset,
                               optionsText: 'name'">
            </select>
        </div>
    </div>
    <div class='col-md-2'>
        <label for="choose-dataset">Chart Type: </label>
        <select class="form-control vertically-align" id="choose-chart"
                data-bind="options: charts,
                           value: selected.chart,
                           optionsText: 'name'">
        </select>
    </div>
    <div class='col-md-2'>
        <label for="choose-dataset">Left: </label>
        <select class="form-control vertically-align" id="choose-left"
                    data-bind="options: selected.dataset().data,
                               value: selected.left,
                               optionsText: 'name'">
        </select>
    </div>
    <div class='col-md-2' data-bind="visible: selected.chart().is2d">
        <label for="choose-dataset">Right: </label>
        <select class="form-control vertically-align" id="choose-right"
                    data-bind="options: selected.dataset().data,
                               value: selected.right,
                               optionsText: 'name'">
        </select>
    </div>
</div>

<div class='row'>
    <div id="data-visualization" class='col-md-4'>

    </div>
</div>

</div>

</body>
</html>